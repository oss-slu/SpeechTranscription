name: Build SpeechTranscription (macOS)

on:
  workflow_call:
  push:
    branches:
      - main
      - fix-exe
      - testingv4artifact
      - issue169_dependency
      - issue178_build-test-failures
      - issue-2-cicd-logging
      - macOS-testRelease

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      # Checkout code
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # Setup Python
      - uses: actions/setup-python@v4
        with:
          python-version: 3.11.7

      # Cache pip dependencies
      - uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}

      # Install system dependencies
      - name: Install system dependencies
        run: |
          brew install mysql pkg-config
          brew install ffmpeg portaudio
          pip install pyaudio

      # Install Python dependencies and NLTK corpora
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pyinstaller importlib-metadata sacremoses tokenizers
          pip install mysql-connector-python
          
          # âœ… Download NLTK resources for offline use
          python -m nltk.downloader punkt averaged_perceptron_tagger stopwords vader_lexicon wordnet omw-1.4

      - name: Unzip NLTK corpora
        run: |
          # go to the NLTK data folder
          cd Users/runner/nltk_data

          # unzip all .zip files (wordnet.zip, omw-1.4.zip, stopwords.zip, etc.)
          for f in *.zip; do
            echo "ðŸ“¦ Unzipping $f..."
            unzip -o "$f" -d "${f%.zip}"
            rm "$f"
          done

          # verify contents
          echo "âœ… NLTK corpora after extraction:"
          find . -maxdepth 2 -type d


      - name: Initialize Git submodules
        run: git submodule update --init --recursive

      - name: Remove obsolete typing package
        run: pip uninstall -y typing || echo "typing not installed"

      - name: Build macOS App
        run: |
          echo "Starting PyInstaller build..."
          pyinstaller \
            --name "Saltify" \
            --windowed \
            --noconfirm \
            --onefile \
            --add-data "nltk_data:./nltk_data" \
            --add-data "images:images" \
            --add-data "build_assets/en-model.slp:pattern/text/en" \
            --add-data "CTkXYFrame:CTkXYFrame" \
            --collect-data whisper \
            --collect-data lightning_fabric \
            --collect-data pytorch_lightning \
            --collect-data pyannote.audio \
            --collect-data sv_ttk \
            --copy-metadata torch \
            --copy-metadata tqdm \
            --copy-metadata regex \
            --copy-metadata sacremoses \
            --copy-metadata requests \
            --copy-metadata packaging \
            --copy-metadata filelock \
            --copy-metadata numpy \
            --copy-metadata tokenizers \
            --copy-metadata importlib_metadata \
            --hidden-import lightning_fabric \
            --hidden-import torch \
            --hidden-import torchvision \
            --hidden-import pytorch_lightning \
            --hidden-import pyannote.audio \
            GUI.py

      # Upload built artifact
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: SpeechTranscription_macOS
          path: dist/Saltify
