on: 
  push:
    branches:
      - main
      - fix-mac-exe
      - testingv4artifact
      - issue169_dependency
      - issue178_build-test-failures
      - 182_fixing_executable

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      - name: Set BASE_DIR
        run: echo "BASE_DIR=$(pwd)" >> $GITHUB_ENV
      # Step 1: Check out the repository
      - uses: actions/checkout@v4
      # Step 2: Set up Python
      - uses: actions/setup-python@v4
        with:
          python-version: 3.11
      # Step 3: Install Homebrew
      - name: Install Homebrew
        run: |
          if ! command -v brew &> /dev/null; then
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi
      # Step 4: Install MySQL and other Homebrew packages
      - name: Install MySQL and required packages
        run: |
          brew install mysql pkg-config 
          brew install portaudio
          brew install ffmpeg
          pip install pyaudio
      # Set MySQL environment variables
      - name: Set MySQL environment variables
        run: |
          export MYSQLCLIENT_CFLAGS='pkg-config mysqlclient --cflags'
          export MYSQLCLIENT_LDFLAGS='pkg-config mysqlclient --libs'
          brew services start mysql
      - name: Check MySQL Status
        run: |
          mysqladmin ping || (echo "MySQL failed to start!" && exit 1)
      # Step 5: Install Java (if required)
      - name: Install Java
        run: |
          if ! java -version; then
            brew install openjdk@11
          fi
      # Step 6: Install dependencies
      - name: Install Python dependencies
        run: |
          pip install -r $GITHUB_WORKSPACE/requirements.txt
          pip install pyinstaller importlib-metadata sacremoses tokenizers
      # Uninstall incompatible typing package
      - name: Uninstall typing package
        run: |
          python -m pip uninstall -y typing
      ###############################
      - name: Set Up Python Virtual Environment
        run: |
          python -m venv venv
          source venv/bin/activate
          echo "VIRTUAL_ENV=$(pwd)/venv" >> $GITHUB_ENV
      - name: Verify Python Site-Packages
        run: |
          python -c "import site; print(site.getsitepackages())"
      - name: Install Dependencies
        run: |
          $VIRTUAL_ENV/bin/python -m pip install --upgrade pip
          $VIRTUAL_ENV/bin/python -m pip install -r requirements.txt
      - name: Check Python Site-Packages in Virtual Environment
        run: |
          $VIRTUAL_ENV/bin/python -c "import site; print(site.getsitepackages())"                               
      ###############################          
#      - name: Install Specific Python Version
#        uses: actions/setup-python@v4
#        with:
#          python-version: 3.11.7
      # Step 7: Install and configure NLTK
      - name: Install NLTK and fix SSL issues
        run: |
          pip install nltk certifi
          CERT_PATH=$(python -m certifi)
          export SSL_CERT_FILE=${CERT_PATH}
          export REQUESTS_CA_BUNDLE=${CERT_PATH}
          echo "Downloading NLTK resources..."
          python -c "import nltk; nltk.download('punkt'); nltk.download('averaged_perceptron_tagger')"
      #checking
      - name: Display all environment variables
        run: env
      # Resolve paths for binaries
      - name: Resolve binary paths
        run: |
          PORTAUDIO_PATH=$(brew --prefix portaudio)/lib/libportaudio.dylib
          FFMPEG_PATH=$(which ffmpeg || echo "/usr/local/bin/ffmpeg")
          FFPROBE_PATH=$(which ffprobe || echo "/usr/local/bin/ffprobe")

          echo "PORTAUDIO_PATH=$PORTAUDIO_PATH" >> $GITHUB_ENV
          echo "FFMPEG_PATH=$FFMPEG_PATH" >> $GITHUB_ENV
          echo "FFPROBE_PATH=$FFPROBE_PATH" >> $GITHUB_ENV

          # Debugging: Display resolved paths
          echo "Resolved Paths:"
          echo "PORTAUDIO_PATH=$PORTAUDIO_PATH"
          echo "FFMPEG_PATH=$FFMPEG_PATH"
          echo "FFPROBE_PATH=$FFPROBE_PATH"   
      #paths
      - name: Resolve binary paths
        id: resolve-paths
        run: |
          echo "PORTAUDIO_PATH=$(brew --prefix portaudio)/lib/libportaudio.dylib" >> $GITHUB_ENV
          echo "FFMPEG_PATH=$(which ffmpeg)" >> $GITHUB_ENV
          echo "FFPROBE_PATH=$(which ffprobe)" >> $GITHUB_ENV      
      ###############################
      - name: Verify Installed Packages
        run: |
          python -c "import lightning_fabric; print('lightning_fabric is installed')"

      - name: Debug Python Path
        run: |
          python -c "import sys; print(sys.path)"

      - name: Debug Virtual Environment Path
        run: |
          echo "VIRTUAL_ENV: $VIRTUAL_ENV"
          ls -lah $VIRTUAL_ENV/lib/python3.11/site-packages || echo "No site-packages found"
      - name: List files in the working directory
        run: |
          echo "Current directory: $(pwd)"
          ls -la $(pwd)
      - name: Verify GUI.py location
        run: |
          echo "Listing files in src directory:"
          ls -la $(pwd)/
  
      ###############################
      # # Step 8: Build the executable
      # - name: Build executable
      #   run: |
      #     SITE_PACKAGES=$($VIRTUAL_ENV/bin/python -c 'import site; print(site.getsitepackages()[0])')
      #     pyinstaller --onefile --windowed \
      #       --add-data "$(pwd)/images:images" \
      #       --add-data "$(pwd)/build_assets/en-model.slp:pattern/text/en" \
      #       --add-data "$(pwd)/CTkXYFrame:CTkXYFrame" \
      #       --add-binary "$PORTAUDIO_PATH:." \
      #       --add-binary "$FFMPEG_PATH:." \
      #       --add-binary "$FFPROBE_PATH:." \
      #       --add-data "$VIRTUAL_ENV/lib/python3.11/site-packages/lightning_fabric:lightning_fabric" \
      #       --add-data "$VIRTUAL_ENV/lib/python3.11/site-packages/whisper:whisper" \
      #       --add-data "$VIRTUAL_ENV/lib/python3.11/site-packages/filelock:filelock" \
      #       --add-data "$VIRTUAL_ENV/lib/python3.11/site-packages/pytorch_lightning:torchlightning" \
      #       --add-data "$VIRTUAL_ENV/lib/python3.11/site-packages/pyannote:pyannote" \
      #       --hidden-import "lightning_fabric" \
      #       --hidden-import "torch" \
      #       --hidden-import "torchvision" \
      #       --hidden-import "pytorch_lightning" \
      #       --hidden-import "pyannote.audio" \
      #       "$(pwd)/GUI.py"
      # #######################################     
      # - name: Debug File Paths
      #   run: |
      #    ls -la /Users/runner/work/SpeechTranscription/SpeechTranscription
      #    ls -la /Users/runner/work/SpeechTranscription/SpeechTranscription/.github/workflows       
      # - name: Debug Directory Structure
      #   run: |
      #     echo "Current Directory: $(pwd)"
      #     echo "Listing Files and Directories:"
      #     ls -R
      # - name: Verify Required Files and Directories
      #   run: |
      #     if [ ! -d "$BASE_DIR/images" ]; then
      #       echo "Error: Directory $BASE_DIR/images not found!"
      #       exit 1
      #     fi
      #     if [ ! -d "$BASE_DIR/build_assets" ]; then
      #       echo "Error: Directory $BASE_DIR/build_assets not found!"
      #       exit 1
      #     fi      
      #######################################      

      # Step 9: Run the Saltify build script
      - name: Run Saltify Build Script
        run: |
          git update-index --chmod=+x .github/workflows/build-saltify.sh
          chmod +x .github/workflows/build-saltify.sh
          ./.github/workflows/build-saltify.sh                
      # Step 10: Upload the built artifact
      - name: Upload macOS Build Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: SpeechTranscription_macos
          path: dist/Saltify
      # Finding why exe isnt created
      - name: Verify PyInstaller build output
        run: |
          echo "Contents of dist folder:"
          ls -la dist/ 